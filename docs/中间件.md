# GinRecovery 中间件文档

## 概述

`GinRecovery` 中间件用于捕获 Gin 框架中的 panic，并根据错误类型进行不同的处理，确保应用程序的稳定性。

## 功能特性

- ✅ 自动恢复 panic，防止应用崩溃
- ✅ 区分处理网络连接错误和代码逻辑错误
- ✅ 可配置是否记录堆栈信息
- ✅ 智能日志记录，避免敏感信息泄露

## 使用方法

### 在路由初始化中使用

```go
// initialize/router.go
func InitRouter() *gin.Engine {
    router := gin.New()

    // 开启堆栈记录（开发环境）
    router.Use(middleware.GinRecovery(true))

    // 或关闭堆栈记录（生产环境，减少日志量）
    // router.Use(middleware.GinRecovery(false))

    return router
}
```

## 错误处理机制

### 1. 网络连接错误处理

**触发场景**：
- 客户端在请求过程中断开连接
- 网络异常中断

**错误信息示例**：
```
write tcp 127.0.0.1:8080->127.0.0.1:54321: broken pipe
write tcp 127.0.0.1:8080->127.0.0.1:54321: connection reset by peer
```

**处理结果**：
```go
// 只记录基本错误信息，不记录堆栈
global.Log.Error("/api/upload",
    zap.Any("error", "broken pipe"),
    zap.String("request", "POST /api/upload HTTP/1.1\r\nHost: localhost:8080\r\n..."),
)
// 不返回 HTTP 状态码（连接已断开）
c.Abort()
```

### 2. 代码逻辑错误处理（开启堆栈记录）

**触发场景**：
- 数组越界访问
- 空指针引用
- 其他运行时错误

**错误信息示例**：
```
runtime error: index out of range [5] with length 2
runtime error: invalid memory address or nil pointer dereference
```

**处理结果**（`stack=true`）：
```go
global.Log.Error("[Recovery from panic]",
    zap.Any("error", "runtime error: index out of range [5] with length 2"),
    zap.String("request", "GET /api/user/info HTTP/1.1\r\nHost: localhost:8080\r\n..."),
    zap.String("stack", `goroutine 1 [running]:
runtime/debug.Stack(0x0, 0x0, 0x0)
    /usr/local/go/src/runtime/debug/stack.go:24 +0x9f
main.GetUserInfo.func1(0xc000102000)
    /app/api/user.go:45 +0x6f
panic(0x13c5040, 0xc000010230)
    /usr/local/go/src/runtime/panic.go:969 +0x175
main.GetUserInfo(0xc000102000)
    /app/api/user.go:42 +0x8a`),
)
c.AbortWithStatus(500) // 返回 500 错误
```

## 错误类型对比

| 类型 | 影响 | 处理方式 |
|------|------|----------|
| **代码逻辑 panic** | 服务器内部错误 | 记录堆栈，返回 500 错误 |
| **连接断开 panic** | 客户端已离开，无法发送响应 | 只记录错误，不返回响应 |

## 配置建议

### 开发环境
```go
// 开启详细堆栈信息，便于调试
router.Use(middleware.GinRecovery(true))
```

### 生产环境
```go
// 关闭堆栈记录，减少日志体积
router.Use(middleware.GinRecovery(false))
```

## 最佳实践

1. **开发阶段**：始终开启堆栈记录，便于快速定位问题
2. **生产环境**：根据日志存储和查询需求决定是否开启堆栈记录
3. **监控告警**：结合日志监控系统，对 panic 错误进行告警
4. **错误分析**：定期分析 panic 日志，优化代码质量

## 注意事项

- 该中间件应该在其他中间件之前注册
- 网络连接错误不会影响其他正常请求的处理
- 堆栈信息可能包含敏感数据，生产环境需谨慎开启

## 相关中间件

建议与以下中间件配合使用：
- `GinLogger` - 请求日志记录
- `Authentication` - 身份验证
- `RateLimit` - 限流控制

---

**版本**: v0.5
**最后更新**: 2025-10-22  
**维护者**: 王得贤
# 图片管理（现阶段架构与实践）

本文面向当前代码库的图片管理模块，梳理入口路由、数据模型、上传与删除流程、静态资源配置、已知问题与后续改造方向，帮助你快速理解现状并指导运维与迭代。

## 背景与目标

- 目标：为业务提供图片的上传、访问与更新能力；图片以静态资源方式对外暴露。
- 现状：上传入口已实现，图片持久化到数据库；静态目录通过路由映射对外服务；删除逻辑部分依赖未实现的后端接口，存在清理不彻底的问题。

## 路由与入口

- 上传入口：`POST /image/upload`
  - 路由注册于 `internal/routers/imageRouter.go`：在 `/image` 分组下提供 `/upload`。
  - 控制器入口：`internal/controllers/imageCtr.go` 中的 `UploadImageCtr()`，调用业务逻辑 `imageLogic.UploadImageLogic` 处理上传。

- 静态资源映射：
  - 在 `inits/routerInit.go` 中，`globals.Router.Static(globals.SConfig.Prefix, globals.SConfig.Path)` 将本地目录映射为静态资源服务。
  - 默认配置（见 `configs/dev.yaml`）：
    - `static.path`: `./static/images`
    - `static.prefix`: `/images`
  - 示例：请求 `GET /images/a.png` 会读取本地文件 `./static/images/a.png`。

## 数据模型（models.Image）

- 文件：`internal/models/image.go`
- 字段：
  - `gorm.Model`（含 `ID/CreatedAt/UpdatedAt/DeletedAt`）
  - `Type`：图片类型（MIME 或扩展名提示，如 `image/png`）。
  - `Size`：文件大小（字节）。
  - `Path`：图片的存储路径（现阶段主要保存以 `/images/...` 为前缀的相对路径）。
  - `Name`：图片名称（文件名）。

说明：现阶段模型未包含存储驱动等多端信息，后续改造将考虑新增 `Driver/Key/URL` 字段以支持多驱动与更稳定的访问策略。

## 上传流程（高层概览）

- 控制器 `UploadImageCtr()` 接收 `multipart/form-data` 文件，进行基础校验（尺寸、类型、数量）。
- 将文件写入本地静态目录（`./static/images`），生成访问路径（`/images/...`）。
- 通过 `pkg/imageutils.InsertImage()` 将图片元数据（类型、大小、路径、名称）持久化到数据库（SQLite/MySQL 取决于你的 `dbInit.go` 配置）。
- 返回给前端可用的访问地址（形如 `/images/...`）。

注：具体细节在 `internal/logics/imageLogic.go` 与 `pkg/imageutils/imageUtil.go` 中实现，实际写盘与路径生成以静态配置为准。

## URL 解析与构造

- 入口：`pkg/imageutils/imageUtil.go`
- 核心函数：`ParseImageURL()` 与 `buildImageFromURL()`
  - 规范化输入 URL（本地 `/images/...` 或远程 `http(s)://...`），提取文件名，构造 `models.Image`。
  - 对本地路径强约束：URL 必须以 `/images/` 开头（对应静态前缀）。
  - 会尝试通过远程头部请求（HEAD）补全 `Size` 信息（远程可用时）。

## 查询与更新

- 查询：`GetImages(ids []uint)` 返回一组图片的路径（供业务层拼接访问）。
- 更新：`UpdateImages(oldImages []models.Image, newImages []models.Image)`
  - 在数据库事务中更新图片记录。
  - 对被替换的旧图片尝试删除对应文件（见下文“删除机制现状”）。

## 删除机制现状

- 文件：`pkg/imageutils/imageUtil.go`
- 设计意图：通过 `sendDeleteRequest()` 向本服务发送 `DELETE` 请求，触发后端删除接口：
  - 目标 URL：`http://{App.Host}:{App.Port}/api/admin/image/delete/{filename}`（由 `buildDeleteURL()` 构造）。
  - 期望行为：后端路由处理删除静态目录中的文件，返回 `200 OK` 表示成功；`404 Not Found` 视为可接受（文件已不存在）。
- 现状问题：项目中并未注册对应的 `DELETE /api/admin/image/delete/:filename` 路由/控制器，因此该请求通常返回 `404`，且实际文件不会被删除。
  - 影响：更新或批量删除时数据库记录会变化，但静态目录可能残留旧文件，长期会产生“垃圾文件”。
- 远程删除：当前逻辑未支持对远程图片的删除（仅日志提示），因此使用远程 URL 的场景无法清理存储端资源。

## 静态资源配置与初始化

- 配置来源：`configs/dev.yaml` 的 `static` 段，以及 `pkg/globals/config.go` 中的 `StaticConfig` 定义：
  - `Path`：静态目录（默认 `./static/images`）。
  - `Prefix`：URL 前缀（默认 `/images`）。
  - `MaxSize`、`MaxUploads`、`AllowedTypes`：上传的大小、数量、类型限制（若配置）。
- 初始化：
  - `inits/staticInit.go` 读取配置，确保静态目录存在（必要时创建）。
  - `inits/routerInit.go` 挂载静态资源路由：`Router.Static(Prefix, Path)`。

## 使用示例

- 上传后，返回的路径示例：`/images/2025/11/10/xxxx.png`
- 前端可直接通过 `GET /images/2025/11/10/xxxx.png` 访问图片。
- 业务模型（如 `internal/models/product.go`）会以图片 `ID` 引用，UI 展示时通过查询得到 URL/Path。

## 已知问题与限制

- 删除接口缺失：`sendDeleteRequest()` 的目标路由未实现，导致本地旧文件无法通过接口清理。
- 本地强耦合：上传与访问依赖于静态目录与前缀，无法无缝切换云端存储。
- 远程删除与清理：对远程 URL 未提供删除与生命周期管理，可能导致外部存储资源无法回收。
- 尺寸获取的稳定性：通过远程 HEAD 获取大小在网络不稳定或跨域下可能失败，建议以上传时的元数据为准。
- 并发与事务：删除与更新在事务中触发，但文件系统操作非事务性的，失败时可能造成库与盘不一致。

## 运维与治理建议

- 监控静态目录容量：定期检查 `./static/images` 的增长情况，评估残留文件比例。
- 后台清理任务：编写离线清理脚本，扫描数据库未引用或已删除记录对应的文件，按规则移除。
- 备份与快照：对静态目录进行定期备份，结合业务重要性确定保留策略。
- 访问前置：如需更高并发或防盗链，可在 `/images` 前加反向代理或 CDN；本地仍作为源站。
- 上传限制：合理配置 `MaxSize`、`AllowedTypes` 与数量限制，降低异常文件风险。

## 近期改造计划（方向性）

- 引入“存储驱动 + 对象池”适配层：将上传/删除下沉到驱动接口，业务只关心 `URL`（对外）与 `Key`（驱动内部定位）。
- 模型扩展：在 `models.Image` 增加 `Driver/Key/URL`，兼容旧 `Path`，读以 `URL` 为主、写双写新老字段。
- 替换删除路径：移除自调用 HTTP 删除，直接调用驱动 `Delete(key)`；本地驱动等价 `os.Remove`。
- 配置化与切换：提供 `current_driver` 与各驱动参数，支持后台接口切换与灰度，逐步接入云存储（七牛/OSS 等）。

## 常见问答（FAQ）

- 问：图片现在存在哪里？
  - 答：默认存于本地 `./static/images`，通过 `/images/...` 访问。

- 问：为什么更新图片后静态目录里还有旧文件？
  - 答：删除接口未实现，导致 `sendDeleteRequest()` 无法真正删除本地文件，后续会改为直接驱动层删除。

- 问：前端该用什么地址展示图片？
  - 答：当前使用 `/images/...`；未来将统一返回规范化 `URL`（本地或云端）。

- 问：能否支持云存储？
  - 答：短期内建议通过适配层接入云驱动；改造完成后可无缝启用。

## 版本信息

- 文档适用：`manpao-service` 现阶段代码结构（生成日期：2025-11-10）。